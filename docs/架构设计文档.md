# 文流 (WenLiu) - 架构设计文档

## 1. 系统架构概览

文流采用现代化的全栈架构，基于Next.js框架构建，结合AI服务和多平台集成，提供完整的内容发布解决方案。

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                              │
├─────────────────────────────────────────────────────────────┤
│                     Next.js 应用层                           │
├─────────────────────────────────────────────────────────────┤
│                      业务逻辑层                               │
├─────────────────────────────────────────────────────────────┤
│                      数据访问层                               │
├─────────────────────────────────────────────────────────────┤
│                 外部服务 & 数据库 & Chrome插件                │
└─────────────────────────────────────────────────────────────┘
```

## 2. 技术栈

### 2.1 前端技术栈
- **框架**: Next.js 14+ (React 18+)
- **样式**: Tailwind CSS
- **状态管理**: React Context + useState
- **UI组件**: Radix UI + 自定义组件
- **类型检查**: TypeScript
- **编辑器**: @uiw/react-md-editor

### 2.2 后端技术栈
- **运行时**: Node.js
- **API**: Next.js API Routes
- **数据库**: SQLite (开发) / Turso (生产)
- **ORM**: Drizzle ORM
- **认证**: NextAuth.js
- **文件存储**: 免费图床服务

### 2.3 AI服务
- **AI模型**: 通义千问等国产AI API
- **格式转换**: Marked.js + 自定义样式
- **内容分析**: 自然语言处理

### 2.4 浏览器扩展
- **Chrome插件**: Manifest V3
- **内容脚本**: 自动填充各平台
- **后台脚本**: 与主应用通信

## 3. 系统模块设计

### 3.1 核心模块

#### 3.1.1 内容编辑模块
```typescript
interface ContentEditor {
  // 编辑器功能
  markdownEditor: MarkdownEditor;
  richTextEditor: RichTextEditor;
  autoSave: AutoSaveService;
  
  // 文档管理
  documentImport: DocumentImportService;
  draftManager: DraftManager;
  versionControl: VersionControlService;
}
```

#### 3.1.2 格式转换模块
```typescript
interface FormatConverter {
  // 平台适配
  wechatConverter: WechatFormatConverter;
  zhihuConverter: ZhihuFormatConverter;
  juejinConverter: JuejinFormatConverter;
  xiaohongshuConverter: XiaohongshuConverter;
  
  // 样式管理
  styleManager: StyleTemplateManager;
  imageProcessor: ImageProcessor;
}
```

#### 3.1.3 AI服务模块
```typescript
interface AIService {
  // 内容优化
  titleOptimizer: TitleOptimizer;
  summaryGenerator: SummaryGenerator;
  tagRecommender: TagRecommender;
  
  // 智能改写
  styleRewriter: StyleRewriter;
  platformAdapter: PlatformAdapter;
}
```

#### 3.1.4 发布管理模块
```typescript
interface PublishManager {
  // 发布配置
  presetManager: PresetManager;
  platformConfig: PlatformConfigManager;
  
  // 发布执行
  chromeExtension: ChromeExtensionService;
  publishTracker: PublishTrackingService;
}
```

### 3.2 数据层设计

#### 3.2.1 数据库模式
```sql
-- 用户表
CREATE TABLE users (
  id TEXT PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  name TEXT,
  avatar TEXT,
  password_hash TEXT,
  subscription_type TEXT DEFAULT 'free',
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- 文章表
CREATE TABLE articles (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES users(id),
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  status TEXT DEFAULT 'draft',
  word_count INTEGER DEFAULT 0,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- 发布记录表
CREATE TABLE publish_records (
  id TEXT PRIMARY KEY,
  article_id TEXT NOT NULL REFERENCES articles(id),
  platform TEXT NOT NULL,
  status TEXT DEFAULT 'pending',
  published_at INTEGER,
  created_at INTEGER NOT NULL
);

-- 发布预设表
CREATE TABLE publish_presets (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES users(id),
  name TEXT NOT NULL,
  config TEXT NOT NULL, -- JSON配置
  is_default BOOLEAN DEFAULT FALSE,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- AI使用记录表
CREATE TABLE ai_usage (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES users(id),
  feature_type TEXT NOT NULL,
  usage_count INTEGER DEFAULT 1,
  month TEXT NOT NULL, -- YYYY-MM格式
  created_at INTEGER NOT NULL
);
```

## 4. API设计

### 4.1 RESTful API 端点

#### 4.1.1 用户相关API
```
POST   /api/auth/register         # 用户注册
POST   /api/auth/login            # 用户登录
GET    /api/users/profile         # 获取用户信息
PUT    /api/users/profile         # 更新用户信息
```

#### 4.1.2 文章相关API
```
GET    /api/articles              # 获取文章列表
POST   /api/articles              # 创建新文章
GET    /api/articles/:id          # 获取文章详情
PUT    /api/articles/:id          # 更新文章
DELETE /api/articles/:id          # 删除文章
```

#### 4.1.3 格式转换API
```
POST   /api/convert/wechat        # 转换为公众号格式
POST   /api/convert/zhihu         # 转换为知乎格式
POST   /api/convert/juejin        # 转换为掘金格式
POST   /api/convert/xiaohongshu   # 转换为小红书格式
```

#### 4.1.4 AI服务API
```
POST   /api/ai/optimize-title     # 标题优化
POST   /api/ai/generate-summary   # 摘要生成
POST   /api/ai/recommend-tags     # 标签推荐
POST   /api/ai/rewrite-style      # 风格改写
```

#### 4.1.5 发布管理API
```
GET    /api/presets               # 获取发布预设
POST   /api/presets               # 创建发布预设
PUT    /api/presets/:id           # 更新发布预设
DELETE /api/presets/:id           # 删除发布预设
POST   /api/publish               # 执行发布
```

## 5. Chrome插件架构

### 5.1 插件结构
```
extension/
├── manifest.json              # 插件配置
├── popup/                     # 弹窗界面
│   ├── popup.html
│   ├── popup.js
│   └── popup.css
├── content/                   # 内容脚本
│   ├── wechat.js             # 公众号填充
│   ├── zhihu.js              # 知乎填充
│   └── common.js             # 通用功能
└── background/                # 后台脚本
    └── background.js
```

### 5.2 插件功能
```typescript
// 平台检测
interface PlatformDetector {
  detectPlatform(): Platform;
  isEditorReady(): boolean;
  getEditorElements(): EditorElements;
}

// 内容填充
interface ContentFiller {
  fillTitle(title: string): void;
  fillContent(content: string): void;
  applyPreset(preset: PublishPreset): void;
  uploadImages(images: Image[]): Promise<void>;
}

// 与主应用通信
interface AppCommunication {
  getArticles(): Promise<Article[]>;
  getPresets(): Promise<PublishPreset[]>;
  reportPublishStatus(status: PublishStatus): void;
}
```

## 6. 安全架构

### 6.1 认证与授权
- **JWT Token**: 用户身份认证
- **会话管理**: NextAuth.js统一管理
- **API保护**: 中间件验证用户权限
- **CSRF防护**: 内置CSRF Token验证

### 6.2 数据安全
- **密码加密**: bcryptjs哈希存储
- **输入验证**: Zod schema验证
- **SQL注入防护**: Drizzle ORM参数化查询
- **XSS防护**: 内容过滤和转义

### 6.3 隐私保护
- **数据最小化**: 只收集必要的用户数据
- **本地处理**: 敏感内容本地处理
- **加密传输**: HTTPS加密通信
- **数据删除**: 支持用户数据删除

## 7. 性能优化

### 7.1 前端优化
- **代码分割**: Next.js自动代码分割
- **图片优化**: Next.js Image组件
- **缓存策略**: 浏览器缓存和SWR
- **懒加载**: 组件按需加载

### 7.2 后端优化
- **数据库优化**: 索引优化和查询优化
- **API缓存**: 内存缓存热点数据
- **CDN**: Vercel Edge Network
- **压缩**: Gzip压缩响应

### 7.3 AI服务优化
- **请求合并**: 批量处理AI请求
- **结果缓存**: 缓存AI生成结果
- **降级策略**: AI服务不可用时的备选方案
- **成本控制**: 用户配额限制

## 8. 部署架构

### 8.1 开发环境
```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=file:./dev.db
    volumes:
      - .:/app
```

### 8.2 生产环境
- **平台**: Vercel Serverless
- **数据库**: Turso (SQLite云服务)
- **CDN**: Vercel Edge Network
- **监控**: Vercel Analytics
- **日志**: Vercel Logs

### 8.3 成本控制
```
Vercel免费版:
- 100GB带宽/月
- 100GB-hours计算时间
- 无限静态部署

Turso免费版:
- 500MB存储
- 1万次读写/月
- 3个数据库

总成本: ¥0/月 (免费额度内)
```

## 9. 监控与运维

### 9.1 应用监控
- **性能监控**: Vercel Analytics
- **错误监控**: 内置错误边界
- **用户行为**: 自定义事件追踪
- **API监控**: 响应时间和成功率

### 9.2 业务监控
- **用户指标**: 注册、活跃、留存
- **功能使用**: AI功能使用统计
- **发布成功率**: 各平台发布成功率
- **收入指标**: 订阅和付费转化

### 9.3 运维自动化
- **自动部署**: Git推送自动部署
- **健康检查**: API健康状态监控
- **备份策略**: 数据库定期备份
- **告警机制**: 异常情况自动告警

## 10. 扩展性设计

### 10.1 平台扩展
- **插件化架构**: 新平台适配插件化
- **配置驱动**: 平台配置外部化
- **API标准化**: 统一的平台适配接口

### 10.2 功能扩展
- **AI能力**: 支持多种AI模型切换
- **样式系统**: 可扩展的样式模板
- **工作流**: 自定义发布工作流

### 10.3 规模扩展
- **数据库**: 支持分库分表
- **缓存**: 分布式缓存系统
- **负载均衡**: 多实例部署

通过这个架构设计，文流能够为用户提供稳定、高效、安全的多平台内容发布服务。